/*
 *                                                                                                      
                                                                                                    
                                                                   "]``]m"                          
                                                                '`dD`````DIcV                       
                                                               ]d```````````Dc"                     
                                                             'cR``````````````c]                    
                                                            Ud`````````````````cR                   
                                                           Ud```````````````````c]                  
                                                          'd`````````````````````cU                 
                                                         Td```````````````````````D                 
                                                         `R```````````````````````c-                
                                                       'Rc`````````````````````````]                
                                                      'd```````````````````````````c                
                                                      ````cc```````````````````````c                
                                                      cPPP5c`````````D`````````````c                
                                                     `D`````````````D5`````````````c                
                                                    -c```````````````cI````````````]                
                                                    `dc\\cIcRI`RP`````D\``````````d'                
                                                    `T ]: TVc\`PR``````cP`````````D                 
                                                    :        I`c:]RdD```Ic```````DV                 
                                                    m       UcR8   cERd``P```````c                  
                                                    'V     Tc`R:   TT 'DcP``````cU                  
                                                     c8   'dR``R        `\``````c                   
                                                    TdDcRdLR```d'       -d`````d'                   
                                                    -c`RPI``````cT      c`````R]                    
                                                    -PPPR```````Rd"   'DR`````dT                    
         '"                                        "cc``````````DIDcRcd``````c8                     
        'ddU                                      ]c`````````````cPR`````````c                      
        c``]                                     ]c```````````````RIPd``````c8                      
       Uc``c                                    8D``c```````````````````````d                       
       c```d                                   Td```\```````````````````````]                       
      Td```c:             8U                   ]R``PR``D```````````````````d'                       
      :R````DP'           `d"                  d``RP``cI```c```````````````c                        
      R``````Rm           R`d'                UD``Ic``P````\````````````````                        
      d```````c           c``D                mR``P``RP```cc```cE?R```````c8                        
     Td```````d8-         c``DV               ]```P``dc```P````<::_```````d'                        
     -c````````Dd        Td```D               8R`RI``P````P```d<::L```````I                         
     "D`````````c-       -c```d'              'd``P``P```cI```P`Rdc```````D                         
     -c`````````R:]-     mR```Rm               `c`P``P```cD```P```````````D                         
     Td``````````dcc     c``````                mcdc`P```cD```P```````````I`T                       
      d````````````D"   Td`````D                   `dLc``Dd```P``````````cmT`                       
      R`````````````cT  ]R`````c                   -]P\Dc\\``dc``````````d'TVU                      
      :R````````````RdDTd``````c                  U8TI`cdRcPPI``````````P]TTT]                      
      Td``````````````R_R``````c                Tm8T-Pd```````````````ddc'TTTmT                     
       R```````````````P```````c              Tmm'TT88:cIcR```````RcIc:]VTTTT']                     
       -c``````````````d````````             8]'TTTT]VVVVmPDcccccDR:VV8`TTTTTTU:                    
        RR````````````````````cV           -c-TTTTTT]VVVVVcVVVVVVVVVVVc'TTTTTTT"8                   
        Td````````````````````d           m`8TTTTTTT`RVVVVcVVVVVVVVVVR-TTTTTTTTTV"                  
         "c``````````````````R]         '`-]TTTTTTTT]]D8V8`VVVVVVVV:dVTTTTTTTTTTT:-                 
          :D`````````````````d'        VmT']TTTTTTTT]VVRDP]VVVV8`ccI8TTTTTTTTTTTTT]T                
           mD````````````````D        m"TT8-TTTTTTTTm8VVV8]RccR`8V`VTTTTTTTTTTTTTTT`                
            :c```````````````I`T    T`-TTT]TTTTTTTTTV:VVVVVVVVVVVR"TTTTTTTTTTTTTTTT-m               
             Vd``````````````P':   '`'TTTT]TTTTTTTTT-`VVVVVVV:V8c-TTTTTTTTTTTTTTT:]mRU              
              'cR```````````I"Tm  ']TTTTT"VTTTTTTTTTTRVVVVVVDdI\'TTTTTTTTTTTTTTT`UTTT]T             
               T`D````````cD-TTm -mTTTTTT]'TTTTTTTTTTRVVVVVVcD`Rd8TTTTTTTTTTTTT]'TTTT']             
                TDd````RdDVTTTTV8mTTTTTTT]TTTTTTTTTTT`VVVVVc8c```DR'TTTTTTTTTTVVTTTTTTUV            
                8'U_dcRm'TTTTTT'DTTTTTTTT]TTTTTTTTTTT:8VV]`'T8D```Rc'TTTTTTTTT]TTTTTTTTm'           
                mT'-'TTTTTTTTTTT]TTTTTTT'mTTTTTTTTTTT'`8c"TTTTc````Rc'TTTTTTT8UTTTTTTTT']           
                :'TTTTTTTTTTTTTT]TTTTTTTV"TTTTTTTTTTTTdmTTTTTT:c````RRTTTTTTT]TTTTTTTTTT""          
                '8TTTTTTTTTTTTTT8'TTTTTTm'TTTTTTTTTTV`-TTTTTTT'd`````cVTTTTT'mTTTTTTTTTTT]          
                 ]TTTTTTTTTTTTTTTTTTTTTT]TTTTTTTTT-`VTTTTTTTTTTD``````DTTTTT8-TTTTTTTTTTT':         
                 :'TTTTTTTTTTTTTTTTTTTTT]TTTTTTT']:TTTTTTTTTTTTD``````cUTTTT]TTTTTTTTTTTTTm'        
                 ':TTTTTTTTTTTTTTTTTTTTT]TTTTT'm]'TTTTTTTTTTTTTD````````TTTT]TTTTTTTTTTTTT']        
                  ]TTTTTTTTTTTTTTTTTTTTT]TTTT8]-TTTTTTTTTTTTTTTD```````cTTTT]TTTTTTTTTTTTTT:'       
                  mTTTTTTTTTTTTTTTTTTTT'mTTT-:TTTTTTTTTTTTTTTTTc```````I'TT'mTTTTTTTTTTTTTT'm       
                  8'TTTTTTTTTTTTTTTTTTT-8TTTm'TTTTTTTTTTTTTTTTT````````c8TT"VTTTTTTTTTTTTTTTmT      
                  '8TTTTTTTTTTTTTTTTTTT""TTT]TTU'TTTTTTTTTTTTTT:c```````]TT8-TTTTTTTTTTTTTTT':      
                   ]TTTTTTTTTTTTTTTTTTT8-TTT]T]V`'TTTTTTTTTTTTT-\```````RTT:'TTTTTTTTTTTTTTTT]      
                   mTTTTTTTTTTTTTTTTTTTm'TTT]T]T-8TTTTTTTTTTT-cdD```````c'Tm'TTTTTTTTTTTTTTTT8'     
                   V-TTTTTTTTTTTTTTTTTT]TTTT]T]-]'TTTTTTTTTT'd``````````P]]cTTTTTTTTTTTTTTTTT'8     
                    mTTTTTTTTTTTTTTTTTT]TTTT]T'8-TTTTTTTTmccdc``````````D8T"`VTTTTTTTTTTTTTTTTm     
                    ]TTTTTTTTTTTTTTTTTT]TTTT]TTTTTTTT'8V"d````````````````TTTV]m'TTTTTTTTTTTTT]     
                    '8TTTTTTTTTTTTTTTTV"TTTT]TTTT'U-TRcDcR```````````````]TTTTT':]]UTTTTTTTTTT8'    
                     ]TTTTTTTTTTTTTTTT`TTTT'd`]m8Icddc``````````````````RmTTTTTTTTT'TTTTTTTTTT-V    

*/


using System;
using System.IO;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Drawing;

namespace ASCII_art
{
    class Program
    {
        static string path = Directory.GetCurrentDirectory();

        static Bitmap asciiImage = (Bitmap)Image.FromFile(path + "/ascii.bmp");

        static List<Icon> iconList = new List<Icon>();

        static Random rnd = new Random();

        static int iconWidth = 13;
        static int iconHeight = 13;

        static int randint(int low, int high)
        {
            return rnd.Next(low, high + 1);
        }

        static int GetBlackPixels(int x1, int y1, int x2, int y2)
        {
            int blackPixels = 0;

            for (int y = y1; y < y2; y++)
            {
                for (int x = x1; x < x2; x++)
                {
                    if (asciiImage.GetPixel(x, y).B == 0 && asciiImage.GetPixel(x, y).G == 0 && asciiImage.GetPixel(x, y).R == 0)
                    {
                        blackPixels++;
                    }
                }
            }

            return blackPixels;
        }

        static int GetClosestIconIndex(float darknessValue)
        {
            int index = 0;

            float lowestDifference = 100;
            
            for (int i = 0; i < iconList.Count; i++ )
            {
                if (Math.Abs(iconList[i].blackPixels - darknessValue) < lowestDifference)
                {
                    lowestDifference = Math.Abs(iconList[i].blackPixels - darknessValue);

                    index = i;
                }
            }

            return index;
        }
                
        static void DrawASCIIArt(string filename)
        {
            Bitmap sourceImg = (Bitmap)Image.FromFile(path + "/" + filename + ".bmp");

            Console.WriteLine("Loaded image.");

            int[,] darknessValues = new int[sourceImg.Width, sourceImg.Height];
            int[,] indices = new int[sourceImg.Width, sourceImg.Height];

            for (int y = 0; y < sourceImg.Height; y++)
            {
                for (int x = 0; x < sourceImg.Width; x++)
                {
                    darknessValues[x, y] = sourceImg.GetPixel(x, y).R + sourceImg.GetPixel(x, y).G + sourceImg.GetPixel(x, y).B;
                    indices[x, y] = GetClosestIconIndex(36f - (float)darknessValues[x, y] / 21.25f);
                }
            }

            Console.WriteLine("Calculated values.");

            //Write to a file
            using (StreamWriter sw = File.CreateText(path + "\\" + filename + " - ASCII.txt"))
            {
                for (int y = 0; y < sourceImg.Height; y++)
                {
                    sw.Write("    ");
                    for (int x = 0; x < sourceImg.Width; x++)
                    {
                        Icon icon = iconList[indices[x, y]];
                        sw.Write(icon.character);
                    }
                    sw.Write("\n");
                }
            }

            Console.WriteLine("Wrote to text file.");
            
            //Draw and save image:

            //create empty bitmap of the right size
            Bitmap newBmp = new Bitmap(sourceImg.Width * iconWidth, sourceImg.Height * iconHeight);

            //drawing
            using (Graphics g = Graphics.FromImage(newBmp)) //not mine
            {
                g.Clear(Color.White); //not mine

                for (int y = 0; y < sourceImg.Height; y++)
                {
                    for (int x = 0; x < sourceImg.Width; x++)
                    {
                        Icon icon = iconList[indices[x, y]];
                        g.DrawImage(asciiImage, new Rectangle(x * iconWidth, y * iconHeight, iconWidth, iconHeight), new Rectangle((int)icon.position.X, (int)icon.position.Y, iconWidth, iconHeight), GraphicsUnit.Pixel);
                    }
                }
            }

            Console.WriteLine("Drawn image.");

            newBmp.Save(filename + " - ASCII.bmp");

            Console.WriteLine("Saved image.");
        }

        static void Main(string[] args)
        {
            //Get the amount of pixels per icon (more pixels -> darker)
            for (int iconY = 0; iconY < 6; iconY++ )
            {
                for (int iconX = 0; iconX < 16; iconX++)
                {
                    int blacks = GetBlackPixels(iconX * iconWidth, iconY * iconHeight, (iconX + 1) * iconWidth, (iconY + 1) * iconHeight);
                    
                    iconList.Add(new Icon(new Vector2(iconX * iconWidth, iconY * iconHeight), blacks, (char)((iconY - 1) * iconHeight + iconX + 45)));
                }
            }

            iconList.Sort();

            Console.WriteLine("Recommend resolutions: ");
            Console.WriteLine(" - For Reddit: max 105x141");
            Console.WriteLine(" - For Others: max 1920x1080 for drawing, text will work for 4K");
            Console.Write("Filename of the source picture: ");
            string filename = Console.ReadLine();

            if (File.Exists(path + "/" + filename + ".bmp"))
            {
                DrawASCIIArt(filename);
            }
            else
            {
                Console.WriteLine("File not found. Exiting application.");
                Console.ReadKey();
                Environment.Exit(0);
            }
            
            Console.ReadKey();
        }
    }
}
