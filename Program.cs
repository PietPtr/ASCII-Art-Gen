/*
 *  ################################################################################################
    ################################################################################################
    ###############################################################%`cc`p%##########################
    ############################################################*cgGcccccGLfY#######################
    ###########################################################`gcccccccccccGf%#####################
    #########################################################*fUccccccccccccccf`####################
    ########################################################XgcccccccccccccccccfU###################
    #######################################################Xgcccccccccccccccccccf`##################
    ######################################################*gcccccccccccccccccccccfX#################
    #####################################################WgcccccccccccccccccccccccG#################
    #####################################################cUcccccccccccccccccccccccf0################
    ###################################################*Ufccccccccccccccccccccccccc`################
    ##################################################*gcccccccccccccccccccccccccccf################
    ##################################################ccccffcccccccccccccccccccccccf################
    ##################################################fSSS8fcccccccccGcccccccccccccf################
    #################################################cGcccccccccccccG8cccccccccccccf################
    ################################################0fcccccccccccccccfLcccccccccccc`################
    ################################################cgf__fLfULcUScccccG_ccccccccccg*################
    ################################################cW#`=#WYf_cSUccccccfScccccccccG#################
    ################################################=########Lcf=`UgGcccLfcccccccGY#################
    ################################################p#######XfU;###fHUgccScccccccf##################
    ################################################*Y#####WfcU=###WW#*GfSccccccfX##################
    #################################################f;###*gUccU########c_ccccccf###################
    ################################################WgGfUgOUcccg*#######0gcccccg*###################
    ################################################0fcUSLccccccfW######fcccccU`####################
    ################################################0SSSUcccccccUg%###*GUcccccgW####################
    #####*%########################################%ffccccccccccGLGfUfgccccccf;#####################
    ####*ggX######################################`fcccccccccccccfSUcccccccccf######################
    ####fcc`#####################################`fcccccccccccccccULSgccccccf;######################
    ###Xfccf####################################;Gccfcccccccccccccccccccccccg#######################
    ###fcccg###################################Wgccc_ccccccccccccccccccccccc`#######################
    ##Wgcccf=#############;X###################`UccSUccGcccccccccccccccccccg*#######################
    ##=UccccGS*###########cg%##################gccUSccfLcccfcccccccccccccccf########################
    ##UccccccUp###########Ucg*################XGccLfccScccc_cccccccccccccccc########################
    ##gcccccccf###########fccG################pUccSccUScccffcccfHBUcccccccf;########################
    #Wgcccccccg;0#########fccGY###############`cccSccgfcccScccc?==bcccccccg*########################
    #0fccccccccGg########WgcccG###############;UcULccSccccScccg?==OcccccccL#########################
    #%Gcccccccccf0#######0fcccg*##############*gccSccScccfLcccScUgfcccccccG#########################
    #0fcccccccccU=`0#####pUcccUp###############cfcSccScccfGcccScccccccccccG#########################
    #Wgccccccccccgff#####fcccccc################pfgfcScccfGcccScccccccccccLcW#######################
    ##gccccccccccccG%###WgcccccG###################cgOfccGgcccSccccccccccfpWc#######################
    ##UcccccccccccccfW##`Ucccccf###################0`S_Gf__ccgfccccccccccg*WYX######################
    ##=UccccccccccccUgGWgccccccf##################X;WLcfgUfSSLccccccccccS`WWW`######################
    ##WgccccccccccccccUbUccccccf################Wp;W0Sgcccccccccccccccggf*WWWpW#####################
    ###UcccccccccccccccScccccccf##############Wpp*WW;;=fLfUcccccccUfLf=`YWWWW*`#####################
    ###0fccccccccccccccgcccccccc#############;`*WWWW`YYYYpSGfffffGU=YY;cWWWWWWX=####################
    ####UUccccccccccccccccccccfY###########0f0WWWWWW`YYYYYfYYYYYYYYYYYf*WWWWWWW%;###################
    ####Wgccccccccccccccccccccg###########pc;WWWWWWWcUYYYYfYYYYYYYYYYU0WWWWWWWWWY%##################
    #####%fccccccccccccccccccU`#########*c0`WWWWWWWW``G;Y;cYYYYYYYY=gYWWWWWWWWWWW=0#################
    ######=Gcccccccccccccccccg*########YpW*`WWWWWWWW`YYUGS`YYYY;cffL;WWWWWWWWWWWWW`W################
    #######pGccccccccccccccccG########p%WW;0WWWWWWWWp;YYY;`UffUc;YcYWWWWWWWWWWWWWWWc################
    ########=fcccccccccccccccLcW####Wc0WWW`WWWWWWWWWY=YYYYYYYYYYYU%WWWWWWWWWWWWWWWW0p###############
    #########YgccccccccccccccS*=###*c*WWWW`WWWWWWWWW0cYYYYYYY=Y;f0WWWWWWWWWWWWWWW=`pUX##############
    ##########*fUcccccccccccL%Wp##*`WWWWW%YWWWWWWWWWWUYYYYYYGgL_*WWWWWWWWWWWWWWWcXWWW`W#############
    ###########WcGccccccccfG0WWp#0pWWWWWW`*WWWWWWWWWWUYYYYYYfGcUg;WWWWWWWWWWWWW`*WWWW*`#############
    ############WGgccccUgGYWWWWY;pWWWWWWW`WWWWWWWWWWWcYYYYYf;fcccGU*WWWWWWWWWWYYWWWWWWXY############
    ############;*XbgfUp*WWWWWW*GWWWWWWWW`WWWWWWWWWWW=;YY`c*W;GcccUf*WWWWWWWWW`WWWWWWWWp*###########
    ############pW*0*WWWWWWWWWWW`WWWWWWW*pWWWWWWWWWWW*c;f%WWWWfccccUf*WWWWWWW;XWWWWWWWW*`###########
    ############=*WWWWWWWWWWWWWW`WWWWWWWY%WWWWWWWWWWWWgpWWWWWW=fccccUUWWWWWWW`WWWWWWWWWW%%##########
    ############*;WWWWWWWWWWWWWW;*WWWWWWp*WWWWWWWWWWYc0WWWWWWW*gcccccfYWWWWW*pWWWWWWWWWWW`##########
    #############`WWWWWWWWWWWWWWWWWWWWWW`WWWWWWWWW0cYWWWWWWWWWWGccccccGWWWWW;0WWWWWWWWWWW*=#########
    #############=*WWWWWWWWWWWWWWWWWWWWW`WWWWWWW*`=WWWWWWWWWWWWGccccccfXWWWW`WWWWWWWWWWWWWp*########
    #############*=WWWWWWWWWWWWWWWWWWWWW`WWWWW*p`*WWWWWWWWWWWWWGccccccccWWWW`WWWWWWWWWWWWW*`########
    ##############`WWWWWWWWWWWWWWWWWWWWW`WWWW;`0WWWWWWWWWWWWWWWGcccccccfWWWW`WWWWWWWWWWWWWW=*#######
    ##############pWWWWWWWWWWWWWWWWWWWW*pWWW0=WWWWWWWWWWWWWWWWWfcccccccL*WW*pWWWWWWWWWWWWWW*p#######
    ##############;*WWWWWWWWWWWWWWWWWWW0;WWWp*WWWWWWWWWWWWWWWWWccccccccf;WW%YWWWWWWWWWWWWWWWpW######
    ##############*;WWWWWWWWWWWWWWWWWWW%%WWW`WWX*WWWWWWWWWWWWWW=fccccccc`WW;0WWWWWWWWWWWWWWW*=######
    ###############`WWWWWWWWWWWWWWWWWWW;0WWW`W`Yc*WWWWWWWWWWWWW0_cccccccUWW=*WWWWWWWWWWWWWWWW`######
    ###############pWWWWWWWWWWWWWWWWWWWp*WWW`W`W0;WWWWWWWWWWW0fgGcccccccf*Wp*WWWWWWWWWWWWWWWW;*#####
    ###############Y0WWWWWWWWWWWWWWWWWW`WWWW`W`0`*WWWWWWWWWW*gccccccccccS``fWWWWWWWWWWWWWWWWW*;#####
    ################pWWWWWWWWWWWWWWWWWW`WWWW`W*;0WWWWWWWWpffgfccccccccccG;W%cYWWWWWWWWWWWWWWWWp#####
    ################`WWWWWWWWWWWWWWWWWW`WWWW`WWWWWWWW*;Y%gccccccccccccccccWWWY`p*WWWWWWWWWWWWW`#####
    ################*;WWWWWWWWWWWWWWWWY%WWWW`WWWW*X0WUfGfUccccccccccccccc`WWWWW*=``XWWWWWWWWWW;*####
    #################`WWWWWWWWWWWWWWWWcWWWW*gc`p;LfggfccccccccccccccccccUpWWWWWWWWW*WWWWWWWWWW0Y####
*/


using System;
using System.IO;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Drawing;

namespace ASCII_art
{
    class Program
    {
        static string path = Directory.GetCurrentDirectory();

        static Bitmap asciiImage = (Bitmap)Image.FromFile(path + "/ascii.bmp");

        static List<Icon> iconList = new List<Icon>();

        static Random rnd = new Random();

        static int iconWidth = 13;
        static int iconHeight = 13;

        static int randint(int low, int high)
        {
            return rnd.Next(low, high + 1);
        }

        static int GetBlackPixels(int x1, int y1, int x2, int y2)
        {
            int blackPixels = 0;

            for (int y = y1; y < y2; y++)
            {
                for (int x = x1; x < x2; x++)
                {
                    if (asciiImage.GetPixel(x, y).B == 0 && asciiImage.GetPixel(x, y).G == 0 && asciiImage.GetPixel(x, y).R == 0)
                    {
                        blackPixels++;
                    }
                }
            }

            return blackPixels;
        }

        static int GetClosestIconIndex(float darknessValue)
        {
            int index = 0;

            float lowestDifference = 100;
            
            for (int i = 0; i < iconList.Count; i++ )
            {
                if (Math.Abs(iconList[i].blackPixels - darknessValue) < lowestDifference)
                {
                    lowestDifference = Math.Abs(iconList[i].blackPixels - darknessValue);

                    index = i;
                }
            }

            return index;
        }
                
        static void DrawASCIIArt(string filename)
        {
            Bitmap sourceImg = (Bitmap)Image.FromFile(path + "/" + filename + ".bmp");

            Console.WriteLine("Loaded image.");

            int[,] darknessValues = new int[sourceImg.Width, sourceImg.Height];
            int[,] indices = new int[sourceImg.Width, sourceImg.Height];

            for (int y = 0; y < sourceImg.Height; y++)
            {
                for (int x = 0; x < sourceImg.Width; x++)
                {
                    darknessValues[x, y] = sourceImg.GetPixel(x, y).R + sourceImg.GetPixel(x, y).G + sourceImg.GetPixel(x, y).B;
                    indices[x, y] = GetClosestIconIndex(36f - (float)darknessValues[x, y] / 21.25f);
                }
            }

            Console.WriteLine("Calculated values.");

            //Write to a file
            using (StreamWriter sw = File.CreateText(path + "\\" + filename + " - ASCII.txt"))
            {
                for (int y = 0; y < sourceImg.Height; y++)
                {
                    sw.Write("    ");
                    for (int x = 0; x < sourceImg.Width; x++)
                    {
                        Icon icon = iconList[indices[x, y]];
                        sw.Write(icon.character);
                        
                    }
                    sw.Write("\n");
                }
            }

            Console.WriteLine("Wrote to text file.");
            
            //Draw and save image:

            //create empty bitmap of the right size
            Bitmap newBmp = new Bitmap(sourceImg.Width * iconWidth, sourceImg.Height * iconHeight);

            //drawing
            using (Graphics g = Graphics.FromImage(newBmp)) //not mine
            {
                g.Clear(Color.White); //not mine

                for (int y = 0; y < sourceImg.Height; y++)
                {
                    for (int x = 0; x < sourceImg.Width; x++)
                    {
                        Icon icon = iconList[indices[x, y]];
                        g.DrawImage(asciiImage, new Rectangle(x * iconWidth, y * iconHeight, iconWidth, iconHeight), new Rectangle((int)icon.position.X, (int)icon.position.Y, iconWidth, iconHeight), GraphicsUnit.Pixel);
                    }
                }
            }

            Console.WriteLine("Drawn image.");

            newBmp.Save(filename + " - ASCII.bmp");

            Console.WriteLine("Saved image.");
        }

        static void Main(string[] args)
        {
            //Get the amount of pixels per icon (more pixels -> darker)
            for (int iconY = 0; iconY < 6; iconY++ )
            {
                for (int iconX = 0; iconX < 16; iconX++)
                {
                    int blacks = GetBlackPixels(iconX * iconWidth, iconY * iconHeight, (iconX + 1) * iconWidth, (iconY + 1) * iconHeight);

                    iconList.Add(new Icon(new Vector2(iconX * iconWidth, iconY * iconHeight), blacks, (char)((iconY - 1) * iconHeight + iconX + 48)));
                }
            }

            iconList.Sort();

            Console.WriteLine("Recommend resolutions: ");
            Console.WriteLine(" - For Reddit: max 105x141");
            Console.WriteLine(" - For Others: max 1920x1080 for drawing, text will work for 4K");
            Console.Write("Filename of the source picture: ");
            string filename = Console.ReadLine();

            if (File.Exists(path + "/" + filename + ".bmp"))
            {
                DrawASCIIArt(filename);
            }
            else
            {
                Console.WriteLine("File not found. Exiting application.");
                Console.ReadKey();
                Environment.Exit(0);
            }
            
            Console.ReadKey();
        }
    }
}
